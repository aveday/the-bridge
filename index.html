<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<script type="text/javascript" src="./js/lib/jq.js"></script>
	<script type="text/javascript" src="./js/lib/Tone.js"></script>


	<script type="text/javascript" src="./js/FloorplanSVG.js"></script>
	<script type="text/javascript" src="./js/utils/HASocket.js"></script>
	<script type="text/javascript" src="./js/utils/LaunchpadController.js"></script>
	<script type="text/javascript" src="./js/utils/AudioContext.js"></script>

	<script type="text/javascript" src="./js/modules/FrequencyChart.js"></script>
	<script type="text/javascript" src="./js/modules/PitchRecorder.js"></script>
	<script type="text/javascript" src="./js/modules/PowerDiverter.js"></script>
	<script type="text/javascript" src="./js/modules/Sequencer.js"></script>
	<script type="text/javascript" src="./js/modules/Unscramble.js"></script>
	<script type="text/javascript" src="./js/modules/BrokenChat.js"></script>
	
	<link rel="stylesheet" href="./css/index.css">
	<link rel="stylesheet" href="./css/modules/PitchRecorder.css">
	<link rel="stylesheet" href="./css/modules/PowerDiverter.css">
	<link rel="stylesheet" href="./css/modules/Sequencer.css">
	<link rel="stylesheet" href="./css/modules/Unscramble.css">
	<link rel="stylesheet" href="./css/modules/BrokenChat.css">

	

	<script type="text/javascript">
		$(function () {



			window.launchpad = new LaunchpadController();
			window.socket = new HASocket();



			let colors = ['yellow','cyan','purple','pink'];

			let toysLeft = [
				{ title:"DIVERT POWER", color:'yellow', instance:new PowerDiverter() },
				{ title:"DECODER", color:'pink', instance:new Unscramble() },
				{ title:"SYNTH SIGNAL", color:'pink', instance:new Sequencer() },
				{ title:"VOCAL SIGNAL", color:'blue', instance:new PitchRecorder() },
				{ title:"TRANSLATOR", color:'blue', instance:new BrokenChat() },

			]

			let toysRight = [
				{ title:"DIVERT POWER", color:'yellow', instance:new PowerDiverter() },
				{ title:"DECODER", color:'pink', instance:new Unscramble() },
				{ title:"SYNTH SIGNAL", color:'pink', instance:new Sequencer() },
				{ title:"VOCAL SIGNAL", color:'blue', instance:new PitchRecorder() },
				{ title:"TRANSLATOR", color:'blue', instance:new BrokenChat() },

			]

			function makeTable(w,h,hasInner){

				let $t = $('<table>');

				for(var r=0; r<h; r++ ){
					let $tr = $('<tr>').appendTo($t);
					for(let c=0; c<w; c++){
						let $td = $('<td>').appendTo($tr).attr('c',c).attr('r',r);
					}
				}

				//outer corners
				$t.find(`[c=0][r=0]`).attr('corner','tl');
				$t.find(`[c=${w-1}][r=0]`).attr('corner','tr');
				$t.find(`[c=${w-1}][r=${h-1}]`).attr('corner','br');
				$t.find(`[c=0][r=${h-1}]`).attr('corner','bl');

				if(hasInner){
					//inner corners
					$t.find(`[c=1][r=1]`).attr('cornice','tl');
					$t.find(`[c=${w-2}][r=1]`).attr('cornice','tr');
					$t.find(`[c=${w-2}][r=${h-2}]`).attr('cornice','br');
					$t.find(`[c=1][r=${h-2}]`).attr('cornice','bl');

					$t.find(`
					[c=${w-2}][r=1], 
					[c=${w-2}][r=${h-2}],
					[c=1][r=${h-2}]`).attr('paint','true');
				}
				

				$t.find(`[c=0], [r=0], [c=${w-1}], [r=${h-1}],
					[c=1][r=1]`).attr('paint','true');

				return $t;
			}

			let audio = new AudioContext();
			audio.add('alert','./audio/sfx-alert.mp3',0.5);
			audio.add('alarm','./audio/sfx-alarm.mp3',0.1,true);
			audio.add('boom','./audio/sfx-boom.mp3',0.5);

			function showChapter(n,title){
				$('chapterline').eq(0).text('CHAPTER '+n);
				$('chapterline').eq(1).text(title);

				$('chapter')
				.css({'opacity':0})
				.animate({'opacity':1},1000)
				.delay(3000)
				.animate({'opacity':0},1000);
			}

			function doDamage( whatKind ){

				audio.play('boom',true);
				audio.play('alert',true);
				audio.play('alarm');
				new OSWarning(whatKind).$el.appendTo('alerts');

				$('container')
				.animate({bottom:-10,left:-10},20)
				.animate({bottom:10,left:10},20)
				.animate({bottom:-20,left:-50},20)
				.animate({bottom:-20,left:-10},20)
				.animate({bottom:0,left:0},20);
			}

			let WormHoleSimulator = function(){
				let self = this;

				audio.add('music','./audio/music-wormhole.mp3',0.5,true);

				self.start = function(){

					$(`<video autoplay loop muted>
					  <source src="./video/video-wormhole.mp4" type="video/mp4">
					</video>`).appendTo('bg');

					audio.play('music');

					setTimeout(function(){ doDamage('CIRCUIT<br>DAMAGE') }, 5000);
					setTimeout(function(){ doDamage('CIRCUIT<br>DAMAGE') }, 10000);
					setTimeout(function(){ doDamage('CIRCUIT<br>DAMAGE') }, 11000);
					setTimeout(function(){ doDamage('CIRCUIT<br>DAMAGE') }, 21000);
					setTimeout(function(){ doDamage('CIRCUIT<br>DAMAGE') }, 22000);

					showChapter(2,'THE WORMHOLE');
				}

				
			}

			let OSWarning = function(text){
				let self = this;
				self.$el = $('<oswarning>').html(text);

			}

			let OSBox = function(color,header,icon){
				
				let toys = [];
				let self = this;
				let w = 14;
				let h = 14;

				let $el = $('<osbox>');
				let $t = makeTable(w,h,true).appendTo($el);

				self.$el = $el;

			
				let paint = [
					''
				]


				$('<h1>').appendTo($el.find('[c=2][r=0]'));
				
				$(`[r=6][c=${w-1}]`).attr('bordered','vert');
				$(`[r=7][c=${w-1}]`).attr('bordered','vert');

				let isStarted = false;
				let iToy = -1;
				async function onLaunchToy(){

					if(!isStarted){

						await Tone.start()

						let meter = new Tone.Meter();
						window.mic = new Tone.UserMedia().connect(meter);

						mic.open().then(() => {
							console.log("mic open");
							
						}).catch(e => {
							console.log("mic not open",e);
						});

						window.synth = new Tone.Synth().toDestination();
						synth.envelope.attack = 0.05;
						synth.envelope.release = 0.5;
						
						isStarted = true;
					}
					
					toToy( $(this).attr('toy') );
				}

				function toToy(iNew,params){
					if(iToy>-1){
						toys[iToy].instance.turnOnOff(false);
						toys[iToy].instance.$el.hide();
					}
	
					iToy = iNew;
					toys[iToy].instance.turnOnOff(true,params);
					toys[iToy].instance.$el.show();
					self.reskin(toys[iToy].title,toys[iToy].color);
				}

				
				self.addToy = function(toy){


					
					/*$(`[r=${2+toys.length}][c=0]`).attr('bordered','top');
					$(`[r=${2+toys.length}][c=0]`).removeAttr('paint').attr('bg',toy.color).attr('bordered','top').text(toy.title).attr('toy',i).click(onLaunchToy);*/
					
					toys.push(toy);

					$(`[r=${2+toys.length}][c=0]`).attr('bordered','top');


					toy.instance.$el.appendTo(self.$toy);
					toy.instance.$el.hide();
				}

				self.reskin = function(title,color){
					$el.find('[paint]').attr('bg',color);
					$el.find('h1').attr('color',color).text(title);
				}

				self.reskin(header,color);

				self.$toy = $('<toy>').appendTo($el.find('[r=1][c=1]'));

				if(icon) $('<osicon>').appendTo(self.$toy).css('background-image','url('+icon+')');

				self.toToy = function(title,params){
					for(var t=0; t<toys.length; t++){
						if(toys[t].title==title) toToy(t,params);
					}
				}
			}

			let osLeft = new OSBox('purple');
			let osRight = new OSBox('yellow');

			osLeft.$el.appendTo('screen[position="left"]');
			osRight.$el.appendTo('screen[position="right"]');

			for(var i=0; i<toysRight.length; i++) osRight.addToy(toysRight[i]);
			for(var i=0; i<toysLeft.length; i++) osLeft.addToy(toysLeft[i]);
			
			osRight.toToy('DIVERT POWER');
			osLeft.toToy('TRANSLATOR');

			
			window.socket.on('circuit_damage',function(params){
				osRight.toToy('DIVERT POWER',params);
			})

			const WIDTH = 4500;
			setInterval(function(){

				let w = $('body').width();
				if(w<WIDTH){
					let scale = w/WIDTH;
					
					$('container').css('transform','scale('+scale+')');
				} else {
					$('container').css('transform','scale(1)');
				}
				

			},1000);

			let simulator = new WormHoleSimulator();

			$('[action="doWormhole"]').click(function(){
				simulator.start();
			})

		})
	</script>

	<title></title>
</head>
<body>
	<bg>
		
	</bg>
	
	<container>
		<screen position='left'></screen>
		<screen position='center'>
			
			<alerts></alerts>
		</screen>
		<screen position='right'></screen>
	</container>
	<debug>
		<button action='doWormhole'>SIMULATE WORMHOLE</button>
		<midi-message>
			
		</midi-message>
	</debug>

	<chapter>
		<chapterline>CHAPTER N</chapterline>
		<hr>
		<chapterline>THE THING</chapterline>
	</chapter>
</body>
</html>